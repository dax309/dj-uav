# 无人机航线管理系统表关系说明

## 表关系图

```
uav_route (航线基础信息表)
    ├── 1:N → uav_waypoint (航点信息表)
    │       └── 1:N → uav_waypoint_action (航点动作表)
    ├── 1:1 → uav_route_mapping (建图参数表)
    └── 1:N → uav_route_coordinate (测区坐标表)
```

## 详细关系说明

### 1. 核心表关系

#### uav_route (航线基础信息表)
- **作用**: 存储航线的全局配置和基本信息
- **主键**: id (BIGSERIAL)
- **关联**: 一对多关联航点表、建图参数表、测区坐标表

#### uav_waypoint (航点信息表)
- **作用**: 存储航线的各个航点详细信息
- **主键**: id (BIGSERIAL)
- **外键**: route_id → uav_route.id
- **关联**: 一对多关联航点动作表

#### uav_waypoint_action (航点动作表)
- **作用**: 存储航点的具体动作指令
- **主键**: id (BIGSERIAL)
- **外键**: 
  - waypoint_id → uav_waypoint.id
  - route_id → uav_route.id (冗余字段，便于查询)

#### uav_route_mapping (建图参数表)
- **作用**: 存储建图航拍、倾斜摄影等特殊航线的参数配置
- **主键**: id (BIGSERIAL)
- **外键**: route_id → uav_route.id
- **关联**: 一对一关联航线表

#### uav_route_coordinate (测区坐标表)
- **作用**: 存储测区多边形的坐标点信息
- **主键**: id (BIGSERIAL)
- **外键**: route_id → uav_route.id
- **关联**: 一对多关联航线表

### 2. 查询场景设计

#### 场景1: 粗略查询航线基本信息
```sql
-- 查询航线列表（基本信息）
SELECT id, route_name, route_description, template_type, 
       route_status, create_time, create_by
FROM uav_route 
WHERE deleted = 0 
ORDER BY create_time DESC;
```

#### 场景2: 详细查询航线及航点信息
```sql
-- 查询航线详细信息（包含航点）
SELECT r.*, w.*, a.*
FROM uav_route r
LEFT JOIN uav_waypoint w ON r.id = w.route_id AND w.deleted = 0
LEFT JOIN uav_waypoint_action a ON w.id = a.waypoint_id AND a.deleted = 0
WHERE r.id = ? AND r.deleted = 0
ORDER BY w.route_point_index, a.action_index;
```

#### 场景3: 查询建图参数
```sql
-- 查询航线建图参数
SELECT r.*, m.*
FROM uav_route r
LEFT JOIN uav_route_mapping m ON r.id = m.route_id AND m.deleted = 0
WHERE r.id = ? AND r.deleted = 0;
```

#### 场景4: 查询测区坐标
```sql
-- 查询航线测区坐标
SELECT r.*, c.*
FROM uav_route r
LEFT JOIN uav_route_coordinate c ON r.id = c.route_id AND c.deleted = 0
WHERE r.id = ? AND r.deleted = 0
ORDER BY c.coordinate_index;
```

### 3. 索引设计

#### uav_route 表索引
- 主键索引: id
- 普通索引: route_status, create_time, template_type

#### uav_waypoint 表索引
- 主键索引: id
- 外键索引: route_id
- 复合索引: (route_id, route_point_index)

#### uav_waypoint_action 表索引
- 主键索引: id
- 外键索引: waypoint_id, route_id
- 普通索引: action_type

#### uav_route_mapping 表索引
- 主键索引: id
- 外键索引: route_id

#### uav_route_coordinate 表索引
- 主键索引: id
- 外键索引: route_id
- 复合索引: (route_id, coordinate_index)

### 4. 数据流转说明

#### buildKmz 方法数据流转
1. 接收 UavRouteReq 请求参数
2. 解析航线基础信息 → 保存到 uav_route 表
3. 解析航点信息 → 保存到 uav_waypoint 表
4. 解析航点动作 → 保存到 uav_waypoint_action 表
5. 解析建图参数 → 保存到 uav_route_mapping 表
6. 解析测区坐标 → 保存到 uav_route_coordinate 表
7. 生成 KMZ 文件并更新文件路径

#### parseKmz 方法数据流转
1. 读取 KMZ 文件
2. 解析 KML 内容
3. 提取航线基础信息
4. 提取航点信息
5. 提取航点动作
6. 提取建图参数
7. 提取测区坐标
8. 返回 KmlInfo 对象

### 5. 性能优化建议

1. **分页查询**: 使用 MyBatis Plus 分页插件
2. **缓存策略**: 对热点数据进行 Redis 缓存
3. **索引优化**: 为常用查询字段建立合适的索引
4. **数据归档**: 定期归档历史数据
5. **读写分离**: 根据业务需要配置读写分离

### 6. 扩展性考虑

1. **字段扩展**: 预留扩展字段，支持新功能
2. **表结构扩展**: 支持新增业务表
3. **分区策略**: 大数据量时考虑表分区
4. **数据迁移**: 支持数据版本升级
