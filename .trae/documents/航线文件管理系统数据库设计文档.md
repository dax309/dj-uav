# 航线文件管理系统数据库设计文档

## 1. 设计概述

本文档基于Spring Boot 3.x + Spring Data JPA + MyBatis Plus + PostgreSQL 15+技术栈，为航线文件管理系统设计数据库表结构。系统主要管理无人机航线信息，包括航线级别的全局配置和航点级别的详细信息。

### 1.1 设计原则
- 航线级别信息与航点级别信息分离存储
- 充分利用PostgreSQL的JSONB、枚举、GIN索引等特性
- 支持高效的增删改查操作
- 保证数据一致性和完整性

## 2. 数据库表设计

### 2.1 航线主表 (uav_routes)

存储航线级别的全局信息和配置参数。

```sql
CREATE TABLE uav_routes (
    id BIGSERIAL PRIMARY KEY,
    route_name VARCHAR(255) NOT NULL COMMENT '航线名称',
    template_type VARCHAR(50) NOT NULL COMMENT '航线类型',
    drone_type INTEGER NOT NULL COMMENT '无人机类型',
    sub_drone_type INTEGER COMMENT '无人机子类型',
    payload_type INTEGER COMMENT '负载类型',
    payload_position INTEGER COMMENT '负载挂载位置',
    image_format VARCHAR(50) COMMENT '负载图片存储类型',
    finish_action VARCHAR(50) COMMENT '航线结束动作',
    exit_on_rc_lost_action VARCHAR(50) COMMENT '失控动作',
    global_height DECIMAL(10,3) COMMENT '全局航线高度(米)',
    auto_flight_speed DECIMAL(8,3) COMMENT '全局航线飞行速度(米/秒)',
    gimbal_pitch_mode VARCHAR(50) COMMENT '云台俯仰角控制模式',
    take_off_ref_point VARCHAR(100) COMMENT '参考起飞点',
    
    -- 使用JSONB存储复杂对象
    waypoint_heading_config JSONB COMMENT '全局偏航角模式配置',
    waypoint_turn_config JSONB COMMENT '全局航点转弯模式配置',
    mapping_config JSONB COMMENT '建图航拍配置参数',
    start_actions JSONB COMMENT '航线初始动作列表',
    
    -- 审计字段
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(100),
    updated_by VARCHAR(100),
    is_deleted BOOLEAN DEFAULT FALSE,
    version INTEGER DEFAULT 1 COMMENT '乐观锁版本号'
);

-- 创建索引
CREATE INDEX idx_uav_routes_template_type ON uav_routes(template_type);
CREATE INDEX idx_uav_routes_drone_type ON uav_routes(drone_type);
CREATE INDEX idx_uav_routes_created_at ON uav_routes(created_at DESC);
CREATE INDEX idx_uav_routes_is_deleted ON uav_routes(is_deleted);

-- 为JSONB字段创建GIN索引
CREATE INDEX idx_uav_routes_waypoint_heading_gin ON uav_routes USING GIN(waypoint_heading_config);
CREATE INDEX idx_uav_routes_waypoint_turn_gin ON uav_routes USING GIN(waypoint_turn_config);
CREATE INDEX idx_uav_routes_mapping_gin ON uav_routes USING GIN(mapping_config);
```

### 2.2 航点表 (uav_waypoints)

存储每个航点的详细信息。

```sql
CREATE TABLE uav_waypoints (
    id BIGSERIAL PRIMARY KEY,
    route_id BIGINT NOT NULL REFERENCES uav_routes(id) ON DELETE CASCADE,
    route_point_index INTEGER NOT NULL COMMENT '航点编号',
    longitude DECIMAL(12,9) NOT NULL COMMENT '经度',
    latitude DECIMAL(12,9) NOT NULL COMMENT '纬度',
    height DECIMAL(10,3) COMMENT '高度(米)',
    speed DECIMAL(8,3) COMMENT '飞行速度(米/秒)',
    gimbal_pitch_angle DECIMAL(8,3) COMMENT '航点云台俯仰角',
    time_interval DECIMAL(8,3) COMMENT '等时拍照间隔时间(秒)',
    distance_interval DECIMAL(8,3) COMMENT '等距拍照间隔距离(米)',
    end_interval_route_index INTEGER COMMENT '停止间隔拍照航点编号',
    
    -- 使用JSONB存储复杂对象
    waypoint_heading_config JSONB COMMENT '航点偏航角配置',
    waypoint_turn_config JSONB COMMENT '航点转弯模式配置',
    actions JSONB COMMENT '航点动作列表',
    
    -- 审计字段
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    is_deleted BOOLEAN DEFAULT FALSE
);

-- 创建索引
CREATE UNIQUE INDEX idx_uav_waypoints_route_point ON uav_waypoints(route_id, route_point_index) WHERE is_deleted = FALSE;
CREATE INDEX idx_uav_waypoints_route_id ON uav_waypoints(route_id);
CREATE INDEX idx_uav_waypoints_coordinates ON uav_waypoints(longitude, latitude);
CREATE INDEX idx_uav_waypoints_is_deleted ON uav_waypoints(is_deleted);

-- 为JSONB字段创建GIN索引
CREATE INDEX idx_uav_waypoints_actions_gin ON uav_waypoints USING GIN(actions);
CREATE INDEX idx_uav_waypoints_heading_gin ON uav_waypoints USING GIN(waypoint_heading_config);
```

### 2.3 坐标点表 (coordinate_points)

存储测区多边形坐标等地理信息。

```sql
CREATE TABLE coordinate_points (
    id BIGSERIAL PRIMARY KEY,
    route_id BIGINT NOT NULL REFERENCES uav_routes(id) ON DELETE CASCADE,
    point_type VARCHAR(50) NOT NULL COMMENT '坐标点类型(polygon, linestring等)',
    point_index INTEGER NOT NULL COMMENT '点序号',
    longitude DECIMAL(12,9) NOT NULL COMMENT '经度',
    latitude DECIMAL(12,9) NOT NULL COMMENT '纬度',
    height DECIMAL(10,3) COMMENT '高度(米)',
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    is_deleted BOOLEAN DEFAULT FALSE
);

-- 创建索引
CREATE INDEX idx_coordinate_points_route_id ON coordinate_points(route_id);
CREATE INDEX idx_coordinate_points_type ON coordinate_points(point_type);
CREATE INDEX idx_coordinate_points_coordinates ON coordinate_points(longitude, latitude);
```

### 2.4 航线文件表 (route_files)

存储生成的KMZ文件信息。

```sql
CREATE TABLE route_files (
    id BIGSERIAL PRIMARY KEY,
    route_id BIGINT NOT NULL REFERENCES uav_routes(id) ON DELETE CASCADE,
    file_name VARCHAR(255) NOT NULL COMMENT '文件名',
    file_path VARCHAR(500) NOT NULL COMMENT '文件路径',
    file_size BIGINT COMMENT '文件大小(字节)',
    file_type VARCHAR(50) DEFAULT 'KMZ' COMMENT '文件类型',
    file_hash VARCHAR(64) COMMENT '文件MD5哈希值',
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    is_deleted BOOLEAN DEFAULT FALSE
);

-- 创建索引
CREATE INDEX idx_route_files_route_id ON route_files(route_id);
CREATE INDEX idx_route_files_file_type ON route_files(file_type);
CREATE INDEX idx_route_files_created_at ON route_files(created_at DESC);
```

## 3. 枚举类型定义

### 3.1 航线模板类型枚举

```sql
CREATE TYPE template_type_enum AS ENUM (
    'waypoint',      -- 航点飞行
    'mapping2d',     -- 建图航拍
    'mapping3d',     -- 倾斜摄影
    'strip'          -- 航带飞行
);
```

### 3.2 无人机类型枚举

```sql
CREATE TYPE drone_type_enum AS ENUM (
    'M300_RTK',      -- 91
    'M350_RTK',      -- 92
    'M30',           -- 67
    'M30T',          -- 68
    'M3E',           -- 77
    'M3T',           -- 78
    'M3M',           -- 79
    'M3D',           -- 80
    'M3TD',          -- 81
    'M4E',           -- 82
    'M4T'            -- 83
);
```

### 3.3 动作类型枚举

```sql
CREATE TYPE action_type_enum AS ENUM (
    'hover',         -- 悬停
    'take_photo',    -- 拍照
    'start_record',  -- 开始录像
    'stop_record',   -- 停止录像
    'gimbal_rotate', -- 云台旋转
    'aircraft_yaw'   -- 飞行器偏航
);
```

## 4. JSONB字段结构说明

### 4.1 waypoint_heading_config 结构

```json
{
    "waypointHeadingMode": "smoothTransition",
    "waypointHeadingAngle": 90.0,
    "waypointPoiPoint": "22.581115,113.940282,0"
}
```

### 4.2 waypoint_turn_config 结构

```json
{
    "waypointTurnMode": "toPointAndStopWithDiscontinuityCurvature",
    "waypointTurnDampingDist": 0.2,
    "useStraightLine": 0
}
```

### 4.3 mapping_config 结构

```json
{
    "collectionMethod": "hover",
    "lensType": "wide",
    "overlapH": 80,
    "overlapW": 70,
    "elevationOptimizeEnable": 1,
    "shootType": "single",
    "direction": "90",
    "margin": "30"
}
```

### 4.4 actions 结构

```json
[
    {
        "actionIndex": 0,
        "hoverTime": 2.0,
        "aircraftHeading": 90.0,
        "takePhotoType": 0,
        "useGlobalImageFormat": 1,
        "imageFormat": "wide",
        "gimbalYawRotateAngle": 0.0,
        "gimbalPitchRotateAngle": -90.0,
        "zoom": 1.0,
        "startRecord": false,
        "stopRecord": false
    }
]
```

## 5. 索引策略

### 5.1 B-Tree索引
- 主键和外键自动创建
- 常用查询字段(template_type, drone_type, created_at等)
- 唯一性约束(route_id + route_point_index)

### 5.2 GIN索引
- JSONB字段的全文检索和属性查询
- 支持复杂的JSON查询操作

### 5.3 复合索引
- (route_id, route_point_index) 用于航点排序查询
- (longitude, latitude) 用于地理位置查询

## 6. 数据完整性约束

### 6.1 外键约束
- uav_waypoints.route_id → uav_routes.id
- coordinate_points.route_id → uav_routes.id
- route_files.route_id → uav_routes.id

### 6.2 检查约束

```sql
-- 经纬度范围检查
ALTER TABLE uav_waypoints ADD CONSTRAINT chk_longitude 
    CHECK (longitude >= -180 AND longitude <= 180);
    
ALTER TABLE uav_waypoints ADD CONSTRAINT chk_latitude 
    CHECK (latitude >= -90 AND latitude <= 90);

-- 航点编号非负检查
ALTER TABLE uav_waypoints ADD CONSTRAINT chk_route_point_index 
    CHECK (route_point_index >= 0);

-- 高度合理性检查
ALTER TABLE uav_waypoints ADD CONSTRAINT chk_height 
    CHECK (height IS NULL OR (height >= -1000 AND height <= 10000));
```

## 7. 性能优化建议

### 7.1 分区策略
- 可按创建时间对大表进行分区
- 按航线类型进行分区以提高查询效率

### 7.2 查询优化
- 使用JSONB操作符进行高效的JSON查询
- 合理使用EXPLAIN ANALYZE分析查询计划
- 定期更新表统计信息

### 7.3 存储优化
- 使用TOAST存储大型JSONB数据
- 定期执行VACUUM和ANALYZE
- 监控表膨胀情况

## 8. 示例查询

### 8.1 查询航线及其航点

```sql
SELECT 
    r.id,
    r.route_name,
    r.template_type,
    json_agg(
        json_build_object(
            'index', w.route_point_index,
            'longitude', w.longitude,
            'latitude', w.latitude,
            'height', w.height,
            'actions', w.actions
        ) ORDER BY w.route_point_index
    ) as waypoints
FROM uav_routes r
LEFT JOIN uav_waypoints w ON r.id = w.route_id AND w.is_deleted = FALSE
WHERE r.is_deleted = FALSE
GROUP BY r.id, r.route_name, r.template_type;
```

### 8.2 基于JSONB的动作查询

```sql
-- 查询包含拍照动作的航点
SELECT w.* 
FROM uav_waypoints w
WHERE w.actions @> '[{"takePhotoType": 0}]'
AND w.is_deleted = FALSE;

-- 查询特定偏航角模式的航线
SELECT r.*
FROM uav_routes r
WHERE r.waypoint_heading_config->>'waypointHeadingMode' = 'smoothTransition'
AND r.is_deleted = FALSE;
```

## 9. 数据迁移和版本控制

### 9.1 Flyway迁移脚本
- V1__Create_base_tables.sql
- V2__Add_jsonb_indexes.sql
- V3__Add_constraints.sql

### 9.2 版本兼容性
- 使用version字段实现乐观锁
- JSONB结构向后兼容
- 新增字段使用默认值

## 10. 监控和维护

### 10.1 性能监控
- 监控慢查询日志
- 跟踪索引使用情况
- 监控JSONB字段大小

### 10.2 数据备份
- 定期全量备份
- 增量备份策略
- 跨地域备份方案

---

本设计文档充分考虑了航线文件管理系统的业务需求，利用PostgreSQL的高级特性提供了高效、可扩展的数据库解决方案。