# 业务逻辑恢复与数据库交互功能说明

## 概述

本文档说明了如何恢复原有的业务逻辑并新增数据库交互功能，同时尽量减少对原有业务逻辑的侵入。

## 恢复的业务逻辑

### 1. buildKmz 方法

**原有逻辑**：
- 将UavRouteReq转换为KmlParams
- 调用RouteFileUtils.buildKmz()生成KMZ文件

**新增功能**：
- 保存航线数据到数据库
- 更新航线记录中的KMZ文件路径

**实现方式**：
```java
@Override
@Transactional(rollbackFor = Exception.class)
public void buildKmz(UavRouteReq uavRouteReq) {
    // 1. 转换请求参数为KmlParams（保持原有业务逻辑）
    KmlParams kmlParams = routeDataConverter.convertToKmlParams(uavRouteReq);
    
    // 2. 保存航线数据到数据库（新增功能）
    Long routeId = saveRouteToDatabase(uavRouteReq);
    
    // 3. 生成KMZ文件（保持原有业务逻辑）
    String fileName = "route_" + routeId + "_" + System.currentTimeMillis();
    String kmzFilePath = RouteFileUtils.buildKmz(fileName, kmlParams);
    
    // 4. 更新航线记录中的KMZ文件路径（新增功能）
    updateRouteKmzPath(routeId, kmzFilePath);
}
```

### 2. parseKmz 方法

**原有逻辑**：
- 读取KMZ文件
- 调用RouteFileUtils.parseKml()解析KML内容

**实现方式**：
```java
@Override
public KmlInfo parseKmz(String fileUrl) throws IOException {
    // 1. 读取KMZ文件（保持原有业务逻辑）
    try (InputStream inputStream = new FileInputStream(fileUrl)) {
        // 2. 解析KML内容（保持原有业务逻辑）
        return RouteFileUtils.parseKml(inputStream);
    }
}
```

### 3. updateKmz 方法

**原有逻辑**：
- 将UavRouteReq转换为KmlParams
- 调用RouteFileUtils.buildKmz()重新生成KMZ文件

**新增功能**：
- 更新航线数据到数据库
- 更新航线记录中的KMZ文件路径

**实现方式**：
```java
@Override
@Transactional(rollbackFor = Exception.class)
public void updateKmz(UavRouteReq uavRouteReq) {
    // 1. 转换请求参数为KmlParams（保持原有业务逻辑）
    KmlParams kmlParams = routeDataConverter.convertToKmlParams(uavRouteReq);
    
    // 2. 更新航线数据到数据库（新增功能）
    Long routeId = getRouteIdFromRequest(uavRouteReq);
    if (routeId != null) {
        updateRouteInDatabase(uavRouteReq, routeId);
        
        // 3. 重新生成KMZ文件（保持原有业务逻辑）
        String fileName = "route_" + routeId + "_" + System.currentTimeMillis();
        String kmzFilePath = RouteFileUtils.buildKmz(fileName, kmlParams);
        
        // 4. 更新航线记录中的KMZ文件路径（新增功能）
        updateRouteKmzPath(routeId, kmzFilePath);
    }
}
```

## 新增的数据库交互功能

### 1. 数据转换工具类

#### RouteDataConverter
- 将UavRouteReq转换为KmlParams
- 将RoutePointReq转换为RoutePointInfo
- 保持原有数据结构不变

#### RouteEntityConverter
- 将UavRouteReq转换为UavRoute实体
- 将RoutePointReq转换为UavWaypoint实体
- 将PointActionReq转换为UavWaypointAction实体
- 将MappingTypeReq转换为UavRouteMapping实体
- 将CoordinatePointReq转换为UavRouteCoordinate实体

### 2. 数据库操作方法

#### saveRouteToDatabase()
- 保存航线基础信息
- 保存航点信息
- 保存航点动作
- 保存建图参数
- 保存测区坐标
- 保存航线初始动作

#### updateRouteInDatabase()
- 更新航线基础信息
- 删除并重新保存航点数据
- 更新建图参数
- 更新测区坐标
- 更新航线初始动作

#### updateRouteKmzPath()
- 更新航线记录中的KMZ文件路径

## 设计原则

### 1. 最小侵入原则
- 保持原有业务逻辑不变
- 新增功能通过工具类实现
- 原有方法调用方式不变

### 2. 事务管理
- 使用@Transactional注解确保数据一致性
- 数据库操作失败时回滚所有操作

### 3. 数据转换
- 通过转换器类实现数据格式转换
- 保持原有数据结构不变
- 支持双向转换

### 4. 错误处理
- 保持原有异常处理机制
- 新增数据库操作异常处理

## 使用说明

### 1. 生成KMZ文件并保存到数据库
```java
// 调用方式不变
routeService.buildKmz(uavRouteReq);
```

### 2. 解析KMZ文件
```java
// 调用方式不变
KmlInfo kmlInfo = routeService.parseKmz(fileUrl);
```

### 3. 更新KMZ文件
```java
// 调用方式不变，但需要确保请求中包含航线ID
routeService.updateKmz(uavRouteReq);
```

## 注意事项

### 1. updateKmz方法的航线ID问题
- 当前实现中getRouteIdFromRequest()方法返回null
- 需要根据实际业务需求实现航线ID的获取逻辑
- 可能的解决方案：
  - 在UavRouteReq中添加routeId字段
  - 通过其他方式确定要更新的航线ID

### 2. 数据一致性
- 使用事务确保数据一致性
- 删除操作使用逻辑删除
- 更新操作先删除后插入

### 3. 性能考虑
- 批量操作时考虑性能优化
- 大量数据时考虑分批处理
- 索引优化提升查询性能

## 扩展建议

### 1. 添加航线ID字段
```java
// 在UavRouteReq中添加
private Long routeId;
```

### 2. 添加数据验证
- 添加请求参数验证
- 添加数据完整性检查
- 添加业务规则验证

### 3. 添加缓存机制
- 对热点数据进行缓存
- 提升查询性能
- 减少数据库压力

### 4. 添加日志记录
- 记录关键操作日志
- 便于问题排查
- 支持审计需求
