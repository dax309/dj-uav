# 无人机航线管理系统数据库设计文档

## 概述

本文档描述了以`buildKmz`和`parseKmz`两个方法为核心的无人机航线管理系统的数据库设计。系统采用SpringBoot 3+、JDK 17+、MyBatis Plus和PostgreSQL技术栈。

## 设计原则

1. **分层设计**：航线基础信息与航点详细信息分离，便于粗略查询和详细查询
2. **关联设计**：通过外键关联，保证数据一致性
3. **扩展性**：预留字段，支持未来功能扩展
4. **性能优化**：合理设计索引，提升查询性能

## 表结构设计

### 1. 航线基础信息表 (uav_route)

**用途**：存储航线的基本信息和全局配置参数

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | BIGSERIAL | 主键ID | 自增主键 |
| route_name | VARCHAR(255) | 航线名称 | 必填 |
| route_description | TEXT | 航线描述 | 可选 |
| template_type | VARCHAR(50) | 航线类型 | 如：MAPPING、PHOTOGRAPHY等 |
| drone_type | INTEGER | 无人机类型 | 字典值 |
| sub_drone_type | INTEGER | 无人机子类型 | 字典值 |
| payload_type | INTEGER | 负载类型 | 字典值 |
| payload_position | INTEGER | 负载挂载位置 | 字典值 |
| image_format | VARCHAR(50) | 负载图片存储类型 | 如：JPEG、RAW等 |
| finish_action | VARCHAR(50) | 航线结束动作 | 如：GO_HOME、HOVER等 |
| exit_on_rc_lost_action | VARCHAR(50) | 失控动作 | 如：HOVER、LAND等 |
| global_height | DECIMAL(10,3) | 全局航线高度 | 单位：米 |
| auto_flight_speed | DECIMAL(10,3) | 全局航线飞行速度 | 单位：m/s |
| waypoint_heading_mode | VARCHAR(50) | 全局偏航角模式 | 如：FREE、FOLLOW等 |
| waypoint_heading_angle | DECIMAL(10,3) | 全局偏航角度 | 单位：度 |
| waypoint_poi_point | VARCHAR(255) | 全局兴趣点 | 坐标字符串 |
| waypoint_turn_mode | VARCHAR(50) | 全局航点转弯模式 | 如：COORDINATE_TURN等 |
| waypoint_turn_damping_dist | DECIMAL(10,3) | 全局航点转弯截距 | 单位：米 |
| use_straight_line | INTEGER | 该航段是否贴合直线 | 0-否，1-是 |
| gimbal_pitch_mode | VARCHAR(50) | 云台俯仰角控制模式 | 如：FREE、FOLLOW等 |
| take_off_ref_point | VARCHAR(255) | 参考起飞点 | 坐标字符串 |
| route_status | INTEGER | 航线状态 | 0-草稿，1-已发布，2-已执行 |
| kmz_file_path | VARCHAR(500) | KMZ文件路径 | 文件存储路径 |
| create_time | TIMESTAMP | 创建时间 | 自动填充 |
| update_time | TIMESTAMP | 更新时间 | 自动填充 |
| create_by | VARCHAR(100) | 创建人 | 用户标识 |
| update_by | VARCHAR(100) | 更新人 | 用户标识 |
| deleted | INTEGER | 逻辑删除标志 | 0-未删除，1-已删除 |

**索引设计**：
- 主键索引：id
- 普通索引：route_status, create_time, template_type

### 2. 航点信息表 (uav_waypoint)

**用途**：存储航线的各个航点详细信息

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | BIGSERIAL | 主键ID | 自增主键 |
| route_id | BIGINT | 航线ID | 外键，关联uav_route.id |
| route_point_index | INTEGER | 航点编号 | 航点顺序号 |
| longitude | DECIMAL(15,10) | 经度 | GPS坐标 |
| latitude | DECIMAL(15,10) | 纬度 | GPS坐标 |
| height | DECIMAL(10,3) | 高度 | 单位：米 |
| speed | DECIMAL(10,3) | 飞行速度 | 单位：m/s |
| waypoint_heading_mode | VARCHAR(50) | 航点偏航角模式 | 覆盖全局设置 |
| waypoint_heading_angle | DECIMAL(10,3) | 航点偏航角度 | 单位：度 |
| waypoint_poi_point | VARCHAR(255) | 航点兴趣点 | 坐标字符串 |
| waypoint_turn_mode | VARCHAR(50) | 航点转弯模式 | 覆盖全局设置 |
| waypoint_turn_damping_dist | DECIMAL(10,3) | 航点转弯截距 | 单位：米 |
| use_straight_line | INTEGER | 该航段是否贴合直线 | 0-否，1-是 |
| gimbal_pitch_angle | DECIMAL(10,3) | 航点云台俯仰角 | 单位：度 |
| time_interval | DECIMAL(10,3) | 等时拍照间隔时间 | 单位：秒 |
| distance_interval | DECIMAL(10,3) | 等距拍照间隔距离 | 单位：米 |
| end_interval_route_index | INTEGER | 停止间隔拍照航点编号 | 关联其他航点 |
| create_time | TIMESTAMP | 创建时间 | 自动填充 |
| update_time | TIMESTAMP | 更新时间 | 自动填充 |
| create_by | VARCHAR(100) | 创建人 | 用户标识 |
| update_by | VARCHAR(100) | 更新人 | 用户标识 |
| deleted | INTEGER | 逻辑删除标志 | 0-未删除，1-已删除 |

**索引设计**：
- 主键索引：id
- 外键索引：route_id
- 复合索引：(route_id, route_point_index)

### 3. 航点动作表 (uav_waypoint_action)

**用途**：存储航点的具体动作指令

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | BIGSERIAL | 主键ID | 自增主键 |
| waypoint_id | BIGINT | 航点ID | 外键，关联uav_waypoint.id |
| route_id | BIGINT | 航线ID | 冗余字段，便于查询 |
| action_index | INTEGER | 动作编号 | 动作执行顺序 |
| hover_time | DECIMAL(10,3) | 飞行器悬停等待时间 | 单位：秒 |
| aircraft_heading | DECIMAL(10,3) | 飞行器目标偏航角 | 单位：度 |
| take_photo_type | INTEGER | 拍照类型 | 0-普通拍照，1-全景拍照 |
| use_global_image_format | INTEGER | 是否使用全局拍照模式 | 0-不使用，1-使用 |
| image_format | VARCHAR(50) | 拍照模式 | 字典值 |
| gimbal_yaw_rotate_angle | DECIMAL(10,3) | 云台偏航角 | 单位：度 |
| gimbal_pitch_rotate_angle | DECIMAL(10,3) | 云台俯仰角 | 单位：度 |
| zoom | DECIMAL(10,3) | 变焦焦距 | 单位：倍 |
| start_record | BOOLEAN | 开始录像 | true/false |
| stop_record | BOOLEAN | 停止录像 | true/false |
| action_type | INTEGER | 动作类型 | 0-航点动作，1-航线初始动作 |
| create_time | TIMESTAMP | 创建时间 | 自动填充 |
| update_time | TIMESTAMP | 更新时间 | 自动填充 |
| create_by | VARCHAR(100) | 创建人 | 用户标识 |
| update_by | VARCHAR(100) | 更新人 | 用户标识 |
| deleted | INTEGER | 逻辑删除标志 | 0-未删除，1-已删除 |

**索引设计**：
- 主键索引：id
- 外键索引：waypoint_id, route_id
- 普通索引：action_type

### 4. 建图参数表 (uav_route_mapping)

**用途**：存储建图航拍、倾斜摄影等特殊航线的参数配置

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | BIGSERIAL | 主键ID | 自增主键 |
| route_id | BIGINT | 航线ID | 外键，关联uav_route.id |
| collection_method | VARCHAR(50) | 采集方式 | 如：GRID、SPIRAL等 |
| lens_type | VARCHAR(50) | 镜头类型 | 如：WIDE、TELE等 |
| overlap_h | INTEGER | 航向重叠率 | 百分比 |
| overlap_w | INTEGER | 旁向重叠率 | 百分比 |
| elevation_optimize_enable | INTEGER | 是否开启高程优化 | 0-否，1-是 |
| shoot_type | VARCHAR(50) | 拍照模式 | 如：SINGLE、BURST等 |
| direction | VARCHAR(50) | 航线方向 | 如：NORTH_SOUTH、EAST_WEST等 |
| margin | VARCHAR(100) | 测区外扩距离 | 单位：米 |
| create_time | TIMESTAMP | 创建时间 | 自动填充 |
| update_time | TIMESTAMP | 更新时间 | 自动填充 |
| create_by | VARCHAR(100) | 创建人 | 用户标识 |
| update_by | VARCHAR(100) | 更新人 | 用户标识 |
| deleted | INTEGER | 逻辑删除标志 | 0-未删除，1-已删除 |

**索引设计**：
- 主键索引：id
- 外键索引：route_id

### 5. 测区坐标表 (uav_route_coordinate)

**用途**：存储测区多边形的坐标点信息

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | BIGSERIAL | 主键ID | 自增主键 |
| route_id | BIGINT | 航线ID | 外键，关联uav_route.id |
| coordinate_index | INTEGER | 坐标点序号 | 多边形顶点顺序 |
| longitude | DECIMAL(15,10) | 经度 | GPS坐标 |
| latitude | DECIMAL(15,10) | 纬度 | GPS坐标 |
| height | DECIMAL(10,3) | 高度 | 单位：米 |
| create_time | TIMESTAMP | 创建时间 | 自动填充 |
| update_time | TIMESTAMP | 更新时间 | 自动填充 |
| create_by | VARCHAR(100) | 创建人 | 用户标识 |
| update_by | VARCHAR(100) | 更新人 | 用户标识 |
| deleted | INTEGER | 逻辑删除标志 | 0-未删除，1-已删除 |

**索引设计**：
- 主键索引：id
- 外键索引：route_id
- 复合索引：(route_id, coordinate_index)

## 表关系图

```
uav_route (航线基础信息表)
    ├── 1:N → uav_waypoint (航点信息表)
    │       └── 1:N → uav_waypoint_action (航点动作表)
    ├── 1:1 → uav_route_mapping (建图参数表)
    └── 1:N → uav_route_coordinate (测区坐标表)
```

## 查询场景设计

### 1. 粗略查询航线基本信息
```sql
-- 查询航线列表（基本信息）
SELECT id, route_name, route_description, template_type, 
       route_status, create_time, create_by
FROM uav_route 
WHERE deleted = 0 
ORDER BY create_time DESC;
```

### 2. 详细查询航线及航点信息
```sql
-- 查询航线详细信息（包含航点）
SELECT r.*, w.*, a.*
FROM uav_route r
LEFT JOIN uav_waypoint w ON r.id = w.route_id AND w.deleted = 0
LEFT JOIN uav_waypoint_action a ON w.id = a.waypoint_id AND a.deleted = 0
WHERE r.id = ? AND r.deleted = 0
ORDER BY w.route_point_index, a.action_index;
```

### 3. 查询建图参数
```sql
-- 查询航线建图参数
SELECT r.*, m.*
FROM uav_route r
LEFT JOIN uav_route_mapping m ON r.id = m.route_id AND m.deleted = 0
WHERE r.id = ? AND r.deleted = 0;
```

### 4. 查询测区坐标
```sql
-- 查询航线测区坐标
SELECT r.*, c.*
FROM uav_route r
LEFT JOIN uav_route_coordinate c ON r.id = c.route_id AND c.deleted = 0
WHERE r.id = ? AND r.deleted = 0
ORDER BY c.coordinate_index;
```

## 性能优化建议

1. **索引优化**：为常用查询字段建立合适的索引
2. **分页查询**：使用MyBatis Plus分页插件
3. **缓存策略**：对热点数据进行Redis缓存
4. **数据归档**：定期归档历史数据
5. **读写分离**：根据业务需要配置读写分离

## 扩展性考虑

1. **字段扩展**：预留扩展字段，支持新功能
2. **表结构扩展**：支持新增业务表
3. **分区策略**：大数据量时考虑表分区
4. **数据迁移**：支持数据版本升级

## 安全考虑

1. **数据备份**：定期备份重要数据
2. **访问控制**：基于角色的数据访问控制
3. **数据加密**：敏感数据加密存储
4. **审计日志**：记录数据变更日志
